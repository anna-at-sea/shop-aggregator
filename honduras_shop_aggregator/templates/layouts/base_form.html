{% extends "layouts/base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{{ heading }} | Cangrejal{% endblock %}
{% block content %}
{% include "partials/flash_message.html" %}

<div class="mb-3">
    <a href="{% url 'index' %}" class="text-decoration-none text-secondary" onclick="handleBack(event)">
        ‚Üê {% translate "Back" %}
    </a>
</div>

    <h1 class="display-5">{{ heading }}</h1>
    <p></p>
    <p>{{ delete_prompt|default:'' }}</p>
    <!-- fff -->
    {% if form.image or heading == _("Update product") %}
        <div class="d-flex align-items-start gap-4 mb-4 flex-wrap">
            <div class="flex-shrink-0">
                <img src="{{ form.instance.image.url }}" 
                     alt="Current product image" 
                     class="img-thumbnail" 
                     style="max-width: 300px; height: auto;">
            </div>
            {% if heading == _("Update product") %}
            <div class="border rounded p-3 bg-light">
                <p class="mb-2 text-secondary">
                    {% translate "Want to change the product image?" %}
                </p>
                <a href="{% url 'product_update_image' form.instance.slug %}" 
                   class="btn btn-outline-secondary btn-sm">
                    üñºÔ∏è {% translate "Update Product Image" %}
                </a>
            </div>
            {% endif %}
        </div>
    {% endif %}
    <form method="post"{% if form.image.value %} enctype="multipart/form-data"{% endif %}>
        {% csrf_token %}
        {{ form|default:form|crispy }}
        <input 
            class="{{ button_class|default:'btn btn-danger' }}"
            type="submit"
            value="{{ button_text }}">
    </form>
{% if heading == _("Registration") %}
    <p class="text-center mt-3">
        {% translate "Already have an account?" %} <a href="{% url 'login' %}">{% translate "Log in here" %}</a>.
    </p>
{% endif %}

<script>
    function handleBack(event) {
      event.preventDefault();
      
      if (document.referrer && document.referrer.startsWith(window.location.origin)) {
        history.back();
      } else {
        window.location.href = '{% url "index" %}';
      }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.querySelector('input[type="file"][name="image"]');
      const existingPreview = document.querySelector('.flex-shrink-0 img'); // your old image on top
    
      if (!fileInput || !existingPreview) return;
    
      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => {
            existingPreview.src = event.target.result; // replaces old image with new preview
          };
          reader.readAsDataURL(file);
        }
      });
    });
</script>

{% endblock %}