{% load i18n %}

{% if products %}
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3 gy-4 justify-content-start">
    {% for product in products %}
    <div class="col d-flex justify-content-center position-relative">
        <div class="card shadow-sm border-primary p-2 card-hover" style="width: 100%; max-width: 320px;">
            {% csrf_token %}
            <button class="btn like-btn position-absolute top-0 end-0 m-2" style="z-index: 10;" data-product-id="{{ product.pk }}">
                {% if user.is_authenticated and product.is_liked %}
                ‚ù§Ô∏è
                {% else %}
                    {% if request.session.liked_products and product.pk in request.session.liked_products %}
                    ‚ù§Ô∏è
                    {% else %}
                    ü§ç
                    {% endif %}
                {% endif %}
            </button>
            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.product_name }}" style="max-height: 300px; object-fit: contain;">
            <div class="card-body">
                <h5 class="card-title mb-2 fw-semibold text-primary">{{ product.product_name }}</h5>
                <a href="{% url 'product_card' product.slug %}" class="text-decoration-none text-dark stretched-link"></a>
                <p class="card-text mb-1">
                    <span class="fs-5 fw-bold text-dark">{{ product.product_price }} L</span>
                </p>
                {% if user.is_authenticated and user == product.seller.user %}
                <strong>{% translate "Stock" %}:</strong> {{ product.stock_quantity }}<br>
                <strong>{% translate "Active" %}:</strong> 
                    {% if product.is_active %}
                        <span class="text-success">{% translate "Yes" %}</span>
                    {% else %}
                        <span class="text-danger">{% translate "No" %}</span>
                    {% endif %}
                <br>
                <strong>{% translate "Saved" %}:</strong> {{ product.likes.all.count }}
                <a href="{% url 'product_update' product.slug %}" class="btn btn-primary btn-sm mt-2">{% translate "Edit Product Info" %}</a>
                {% else %}
                <p class="card-text mb-0 text-muted small">
                    {% translate "Sold by" %}: <span class="fw-medium text-secondary">{{ product.seller }}</span>
                </p>
                <p class="card-text mb-0 text-muted small">
                    {% if current_city == product.origin_city %}
                        <span class="text-success">{% translate "Available in your city" %}</span>
                    {% else %}
                        {% if current_city in product.delivery_cities.all %}
                            <span class="text-success">{% translate "Delivery from" %} {{ product.origin_city.name }}</span>
                        {% else %}
                            <span class="text-danger">{% translate "Not available in your city" %}</span>
                        {% endif %}
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info mt-3">
    {% translate "No products found." %}
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
      const likeButtons = document.querySelectorAll('.like-btn');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
      likeButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          const productId = this.dataset.productId;
          const url = `{% url 'toggle_like' 0 %}`.replace('0', productId);
  
          fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            },
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'liked') {
              this.textContent = '‚ù§Ô∏è';
            } else {
              this.textContent = 'ü§ç';
            }
          })
          .catch(error => console.error('Error:', error));
        });
      });
    });
</script>
